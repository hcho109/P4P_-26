<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EmotionalGUI Annotation WebPage</title>
    <!-- Add icon library -->
    <link 
      rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
      crossorigin="anonymous" referrerpolicy="no-referrer" 
    />
    <link href="annotationStyle.css" rel="stylesheet" type="text/css" />
    <link href="mediaPlayerStyle.css" rel="stylesheet" type="text/css" />
    <link href="navStyle.css" rel="stylesheet" type="text/css" />

    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>
  
    <py-config>
              
      packages = ["numpy", 
                  "matplotlib", 
                  "pandas",
                  "keras"
                  ]
      [[fetch]]
      from = "http://127.0.0.1:5500"
      files = ['plot2d.py', 'annotator.py']
      
      [[interpreters]]
      src = 'https://cdn.jsdelivr.net/pyodide/v0.23.3/full/pyodide.js'
      name = 'pyodide-0.23.3'
      lang = 'python'
    </py-config>
  
  </head>

  <body>
    
    <!-- Top navigation -->
    <header>   
      <div class="website_name">
          <img src="resources/University_of_Auckland_logo.png" alt = "UoA logo">
          <h3>EmotionGUI</h3>
      </div>
      <nav>
          <ul class="nav_links">
            <li><a href="home.html">Home</a></li>
            <li><a class="active" href="annotation.html">Annotation</a></li>
            <li><a href="visualise.html">Visualise</a></li>
            <li><a href="liveAudio.html">Live Audio</a></li>      
          </ul>
      </nav>
      <div class="dropdown">
          <button class="dropbtn">Help 
              <i class="fa fa-caret-down"></i>
          </button>
          <div class="dropdown-content">
              <button onclick = "createPopupWin('#aboutEmotionGUI', 'EmotionGUI', 1000, 650);">EmotionGUI</button>
              <button onclick = "createPopupWin('about/aboutAnnotation.html', 'Annotation', 1000, 650);">Annotation</button>
              <button onclick = "createPopupWin('#aboutVisualise', 'Visualise', 1000, 650);">Visualise</button>
              <button onclick = "createPopupWin('#aboutLiveAudio', 'Live Audio', 1000, 650);">Live Audio</button>
          </div>
      </div> 
    </header>

    <!------------------ Left column ------------------------->
    <div class="split left">
      <div class="centered">
        <div class="subtitle">
          <h3>Video/Audio Multimedia</h3>
        </div>

        <!--Multimedia player tab links-->
        <div class="mediaPlayerTabs">
          <!---------------- Video player tab------------------>
          <input type="radio" id="tabVideoPlayer" name="mediaPlayerTabs" checked="checked">
          <label for="tabVideoPlayer">Video player</label>
          
          <!-- Video player tab content-->
          <div class="mediaPlayerTabcontent">
            <input class="open-file-btn" type="file" accept="audio*,video*" id="video-file-input" value="Open Video File">
            <video class="video" id="video" controls>
              Your browser does not support the video tag.
            </video><br>
            <p id="playerStatus" style="padding-bottom:0">Choose a 'MP4' video file and Click 'Play' button to start playing</p>
            <p style="float:right; font-size:small"> * This video player does not support WMV files </p>
          </div>

          <!------------------ Audio player tab---------------------->
          <input type="radio" id="tabAudioPlayer" name="mediaPlayerTabs">
          <label for="tabAudioPlayer">Audio player</label>

          <!-- Audio player tab content-->
          <div class="mediaPlayerTabcontent">
            <input class="open-file-btn" id="fileinput" type="file" accept="audio*,video*"/>
            <canvas class="canvas_audio" id="canvas_spectrogram"></canvas>
            <canvas class="canvas_audio" id="canvas_waveform"></canvas>
            <audio id="audio" src="" controls="true"></audio>
            <p id="playerStatus">Choose a 'WAV'/'MP3' audio file and Click 'Play' button to start playing</p>
          </div>
        </div>
        
        <span id="playEnabled">Debug: playing?</span>
        <span id="duration">0.00</span>
        <span id="currentTime"> 0.0000 </span>
        <span id="currentTimeinSec"> 0.00 </span>

      </div>
    </div>

    <!------------------ Right Column ----------------->
    <div class="split right">
      <div class="centered">
        <div class="subtitle">
          <h3>Speech Emotion Annotation</h3>
        </div>
        <p>'Click' on the emotional model you want to use to annotate emotions in speech within the tabs below. Enjoy annotating emotions!</p>
      
        <!--Multimedia player tab links-->
        <div class="EMtabs">

          <!----------- discrete/categorical emotion model tab------------------->
          <input type="radio" id="tabCategory" name="EMtabs">
          <label for="tabCategory">Discrete/Categorical</label>
          
          <!-- categorical tab content-->
          <div class="EMtabContent">
            <button class="help_popup_btn" onclick="createPopupWin('about/aboutDisc.html',
            'About', 900, 600);">
              <i class="fas fa-question-circle fa-2xl" style="color: rgb(23, 60, 154);"></i>
            </button>
            <div class="content">
              <h4 style="margin-bottom: 0px; margin-top: 10px">Discrete/Categorical Emotion Model</h4>
              <hr style="height:1.5px;border-width:0;color:gray;background-color:gray;margin-top: none;;margin-left:0;width:260px">
              <p>
                <ul>
                  <li>In a discrete/categorical emotion model, emotions are typically represented 
                    as a fixed set of basic or primary emotions. 
                    Some commonly recognized basic emotions include happiness, sadness, anger, fear, surprise, and disgust.</li>
                  <li>After watching a video/ audio file, write a specific emotion that you believe best describes the overall emotion delivered in the video.  
                    <br><br>For detailed instructions, click on the '?' at the top rigt corner.</li>
                </ul>
              </p>
            </div>
            <div class="inputTextBox">
              <label for="emotionLabel">Emotion description (one word):</label>
              <input type="text" id="emotionLabel" name="emotionLabel" required size="15" >
              <input type="button" class= save_btn id="CSV_btn" value="Save as CSV"><br><br>
            </div>
          </div>

          <!------------- 1D emotion model tab------------------>
          <input type="radio" id="tab1D" name="EMtabs">
          <label for="tab1D">1-D</label>
          
          <!-- 1D tab content-->
          <div class="EMtabContent">
            <button class="help_popup_btn" onclick="createPopupWin('about/about1D.html',
            'About', 900, 600);">
              <i class="fas fa-question-circle fa-2xl" style="color: #ff1500;"></i>
            </button>
            <div class="content">
              <h4 style="margin-bottom: 0px; margin-top: 10px">One-dimensional (1-D) Emotion Model</h4>
              <hr style="height:1.5px;border-width:0;color:gray;background-color:gray;margin-top: none;;margin-left:0;width:275px">
              <p>
                <ul>
                  <li>As you watch a video or listen to an audio, use sliders below to annotate the emotions expressed in terms of valence, arousal and dominance.</li>
                  <li>Adjust each slider independently, focusing on one emotional dimension at a time.<br><br> For detailed instructions, click on the '?' at the top rigt corner.</li>
                </ul>
              </p>
            </div>
            
            <!--Valence slider bar-->
            <div class="range-slider"> 
              <form class="btns_1D">
                <input type="button" class="clear_btn" id="clear_btn" value="Clear values">
                <input type="button" class="save_btn" id="CSV_btn" value="Save as CSV">
              </form>
              <label for="valenceRange">Valence</label> 
              <input class="range-slider__range" type="range" value="0" min="-10" max="10" id="valenceRange" list="values">
              <span class="range-slider__value">0</span><br>
              <span>Unhappy</span>
              <span class="endLabel">Happy</span>
              <img class="samPics" src="resources/valenceSAM.png" alt="SAM valence images">
            </div>
            <hr>
            <!--Arousal slider bar-->
            <div class="range-slider">
              <form class="btns_1D">
                <input type="button" class="clear_btn" id="clear_btn" value="Clear values">
                <input type="button" class="save_btn" id="CSV_btn" value="Save as CSV">
              </form>
              <label for="arousalRange">Arousal</label> 
              <input class="range-slider__range" type="range" value="0" min="-10" max="10" id="arousalRange">
              <span class="range-slider__value">0</span><br>
              <span>Calm</span>
              <span class="endLabel">Excited</span>
              <img class="samPics" src="resources/arousalSAM.png" alt="SAM arousal images">
            </div>
            <hr>
            <!--Dominance slider bar-->
            <div class="range-slider">
              <form class="btns_1D">
                <input type="button" class="clear_btn" id="clear_btn" value="Clear values">
                <input type="button" class="save_btn" id="CSV_btn" value="Save as CSV">
              </form>
              <label for="dominanceRange">Dominance</label>
              <input class="range-slider__range" type="range" value="0" min="-10" max="10" id="dominanceRange">
              <span class="range-slider__value">0</span><br>
              <span>Independent</span>
              <span class="endLabel">Dependent</span>
              <img class="samPics" src="resources/dominanceSAM.png" alt="SAM dominance images">
            </div>
            <hr>

            <form class="btns_1D_all">
              <input type="button" class="clearAll_btn" id="clearAll_1Dbtn" value="Clear all current values">
              <input type="button" class="saveAll_btn" id="saveAll_1Dbtn" value="Save all current values as CSV">
            </form>
          </div>

          <!----------------- 2D emotion model tab------------------->
          <input type="radio" id="tab2D" name="EMtabs" checked="checked">
          <label for="tab2D">2-D</label>
          
          <!-- 2D tab content-->
          <div class="EMtabContent">
            <button class="help_popup_btn" onclick="createPopupWin('about/about2D.html',
            'About', 900, 600);">
              <i class="fas fa-question-circle fa-2xl" style="color: #04AA6D;"></i>
              <span class="helpPopupText" id="2dhelpPopup"></span>
            </button>
            <div class="content">
              <h4 style="margin-bottom: 0px; margin-top: 10px">Two-dimensional (2-D) Emotion Model</h4>
              <hr style="height:1.5px;border-width:0;color:gray;background-color:gray;margin-top: none;;margin-left:0;width:275px">
              <p>
                <ul>
                  <li>Please use the valence-arousal plot below to indicate your perception of emotions in the video or audio.</li>
                  <li> Move your cursor vertically for valence (positivity/negativity) and horizontally for arousal (intensity).<br><br> For detailed instructions, click on the '?' at the top rigt corner.</li>
                </ul>
              </p>
            </div>

            <!--------------- 2D V-A plot-------------->
            <div class="plotCanvas" id="VA-plot"></div>

            <div class="yData" id="yData"> 
              <label for="y_input">y-data:</label>
              <input type="text" id="x_input" required size="5" value="y.yyy">
            </div>

            <div class="xData" id="xData"> 
              <label for="x_input">x-data:</label>
              <input type="text" id="x_input" required size="5" value="x.xxx">
            </div>

            <br>
            <span id="playerEnabled"> player status</span>           
            <span id="MediaDuration"> Debug: raw duration</span>
            <span id="MediaTime"> Debug: raw time </span>
            <span id="MediaTimeInSec"> Debug: time in sec </span>

            <p id="update-note"> Play a media file and then Click anywhere on the plot to start annnotation</p>

            <form class="btns_2D">
              <input type="button" class="clear_btn" id="clear_btn" py-click="clear_plot()" value="Clear">
              <input type="button" class="save_btn" id="CSV_btn" py-click="saveAsCSV()" value="Save as CSV">
              <input type="button" class="reannotate_btn" id="reannotate_btn" py-click="reannotate()" value="Re-annotate">
            </form><br>

          </div>
      </div>
    </div>

    <!-- Audio waveform javascript -->
    <script src='https://codepen.io/bataimx/pen/JjdyXyG.js'></script>
    <script src="annotation_js/audioScript.js"></script>

    <!-- video player javascript -->
    <script src="annotation_js/videoScript.js"></script>

    <!-- Help popup javascript -->
    <script>
      var newWin;
      // When the user clicks on '?' icon, open the help popup
      function createPopupWin(pageURL, pageTitle,
                    popupWinWidth, popupWinHeight) {
            var left = (screen.width - popupWinWidth) / 2;
            var top = (screen.height - popupWinHeight) / 4;
      
            var myWindow = window.open(pageURL, pageTitle,
                    'resizable=yes, width=' + popupWinWidth
                    + ', height=' + popupWinHeight + ', top='
                    + top + ', left=' + left);
        }

    </script>

    <py-script output="VA-plot">
      from plot2d import createCircle
      import matplotlib.pyplot as plt
      from pyodide.ffi import create_proxy
      from js import document

      player_txt = Element("playerEnabled")
      duration_txt = Element("MediaDuration")
      timeRaw_txt = Element("MediaTime")
      time_txt = Element("MediaTimeInSec")
      video=document.getElementById("video")
      audio= document.getElementById("audio")

      seconds = 0
      secondsRaw =0
      mediaDuration =0
      isPlaying = False;

      fig = plt.figure()
      axes = fig.subplots()

      createCircle(axes)

      plt.title("V-A Plot")
      plt.xlabel("Valence")
      plt.ylabel("Arousal")

      display(fig, target="VA-plot")
      
      def getMediaDuration(e):
        from js import duration

        global mediaDuration, isPlaying
        isPlaying = True
        mediaDuration = duration
        
        duration_txt.write(mediaDuration)
        player_txt.write(isPlaying)
      
      def getMediaTime(e):
        from js import currentTime, currentTimeInSec

        global seconds, secondsRaw

        secondsRaw = currentTime
        seconds = currentTimeInSec

        timeRaw_txt.write(secondsRaw)
        time_txt.write(seconds)

      def disablePlayer(e):

        global isPlaying
        isPlaying = False
        player_txt.write(isPlaying)

      video.addEventListener("play", create_proxy(getMediaDuration))
      video.addEventListener("timeupdate", create_proxy(getMediaTime))
      video.addEventListener("pause", create_proxy(disablePlayer))
      video.addEventListener("ended", create_proxy(disablePlayer))

      audio.addEventListener("play", create_proxy(getMediaDuration))
      audio.addEventListener("timeupdate", create_proxy(getMediaTime))
      audio.addEventListener("pause", create_proxy(disablePlayer))
      audio.addEventListener("ended", create_proxy(disablePlayer))
    

    </py-script>
<!--
    <py-script output="VA-plot">
      import js
      from js import isPlaying, duration, currentTime, currentTimeInSec, handleVideoFileChange
      import matplotlib.pyplot as plt
      
      fig = plt.figure()
      axes = fig.subplots()

      #canvas = Element("VA-plot")
      update_note = Element("update-note")

      # js objects converted to equivalent py types
      seconds = currentTimeInSec
      mediaSeconds = duration

      clicked = false
      count_out_of_bounds = 0
      time_points = []
      valence_points = []
      arousal_points = []

      fig.canvas.mpl_connect(
			"button_press_event", annotateOnClick)

      self.mediaPlayer.positionChanged.connect(self.positionChanged)
      self.mediaPlayer.durationChanged.connect(self.durationChanged)
      self.mediaPlayer.error.connect(self.handleError)


      def annotateOnClick(event):
        global clicked, count_out_of_bounds, time_points, valence_points, arousal_points, fig, seconds

        if isPlaying:
          clicked = True
          print(round(event.xdata, 2), round(event.ydata, 2))
          if event is not None and (event.xdata >= -1 and event.xdata <= 1 and event.ydata >= -1 and event.ydata <= 1):
            axes.scatter(round(event.xdata, 2), round(event.ydata, 2), color='red', s=15)
            display(fig, target="VA-plot")
            savePoints(round(event.xdata, 2), round(event.ydata, 2))
            fig.canvas.mpl_connect(
            "motion_notify_event", autoClicking)
          else:
            count_out_of_bounds += 1
            time_points.append(seconds)
            valence_points.append(None)
            arousal_points.append(None)

            update_note.write(
              "You have clicked out of the annotation model {} times. Do you want to re-annotate?".format(count_out_of_bounds))
            fig.canvas.mpl_connect(
            "motion_notify_event", autoClicking)

      def reannotate(self):
        # clear the plot and all the time and emotional coordinates list
        self.clear_plot()
        self.time_points = []
        self.valence_points = []
        self.arousal_points = []
        self.count_out_of_bounds = 0
        self.clicked = False
        # pause the media and begin again
        self.setPosition(0)
        self.mediaPlayer.pause()
        self.out_of_bounds_lbl.setText(
          "You can now begin the annotation again")

      def autoClicking(event):
        global isPlaying, clicked, seconds, mediaSeconds
        if isPlaying and clicked == True:
          if event is not None and (event.xdata != None and event.ydata != None):
            print(round(event.xdata, 2), round(event.ydata, 2))
            if (event.xdata >= -1 and event.xdata <= 1 and event.ydata >= -1 and event.ydata <= 1):
              time_elapsed = seconds
              if float(time_elapsed) <= float(mediaSeconds) / 3:
                print(mediaSeconds)
                color = 'red'
                opacity = 1 - (float(time_elapsed) / (float(mediaSeconds) / 3))
                if opacity < 0:
                  opacity = 0.3
                elif opacity > 1:
                  opacity = 1
              elif float(time_elapsed) > float(self.mediaSeconds) / 3 and float(time_elapsed) <= 2 * float(self.mediaSeconds) / 3:
                color = 'yellow'
                opacity = 1 - ((float(time_elapsed) - (float(self.mediaSeconds) / 3)) / 3)
                print('yellow', opacity)
                if opacity < 0:
                  opacity = 0.3
                elif opacity > 1:
                  opacity = 1
              elif float(time_elapsed) > 2 * float(self.mediaSeconds) / 3:
                color = 'blue'
                opacity = 1 - ((float(time_elapsed) - 2 * (float(self.mediaSeconds) / 3)) / 3)
                print('blue', opacity)
                if opacity < 0:
                  opacity = 0.3
                elif opacity > 1:
                  opacity = 1

              self.axes.scatter(round(event.xdata, 2), round(
                event.ydata, 2), color=color, s=18, alpha=opacity)
              self.canvas.draw()
              self.savePoints(round(event.xdata, 2),
                      round(event.ydata, 2))
            else:
              self.count_out_of_bounds += 1
              self.time_points.append(self.seconds)
              self.valence_points.append(None)
              self.arousal_points.append(None)
              self.out_of_bounds_lbl.setText(
                "You have clicked out of the annotation model {} times. Do you want to re-annotate?".format(self.count_out_of_bounds))

      def savePoints(xdata, ydata):
        valence_points.append(xdata)
        arousal_points.append(ydata)
        time_points.append(seconds)

      def saveAsCSV(self):
        header = ["Time", "Valence", "Arousal"]

        # this opens a dialog box to save the file
        filename = 'annotated-file'
        filename, _ = QFileDialog.getSaveFileName(
          self, "Save CSV file", filename, "CSV Files (*.csv)"
        )
      
        for i in range(len(self.time_points)):
          if i != 0:
              if self.time_points[i] == self.time_points[i-1] or float(self.time_points[i]) < float(self.time_points[i-1]):
                self.time_points[i] = round(float(self.time_points[i-1]) + random.uniform(0.02, 0.07), 2)

        if filename:
          with open(filename, 'w+', newline='') as file:
            writer = csv.writer(file)
            writer.writerow(header)
            rows = [(str(time), str(valence), str(arousal)) for time, valence, arousal in zip(self.time_points,
                                                      self.valence_points, self.arousal_points)]
            writer.writerows(rows)

      def clear_plot(self):

      
    </py-script>
-->

<!-- 
    <py-script>
      from js import document
      from pyodide.ffi import create_proxy

      def handle_file_input(event):
        videoFiles = event.target.files

        if not videoFiles or not videoFiles[0]:
            return

        videoFileUrl = URL.createObjectURL(videoFiles[0])

        # Load the video file
        video = document.getElementById('video')
        video.src = videoFileUrl
        video.play()

      videoFileInput_proxy = create_proxy(handle_file_input)
      videoFileInput = document.getElementById('video-file-input')
      videoFileInput.addEventListener("change", videoFileInput_proxy)
    </py-script> -->

  <!-- videoFileInput = document.getElementById('video-file-input')
      videoFileInput.addEventListener("change", videoFileInput) -->


    <!-- <py-script>
      from js import document, URL
      from pyodide.ffi.wrappers import add_event_listener

      def handle_file_input(event):
        videoFiles = event.target.files

        if not videoFiles or not videoFiles[0]:
            return

        videoFileUrl = URL.createObjectURL(videoFiles[0])

        # Load the video file
        video = document.getElementById('video')
        video.src = videoFileUrl
        video.play()

      add_event_listener(
        document.getElementById('video-file-input'),
        "change",
        handle_file_input
      )

    </py-script> -->
    
    <!-- 1D sliders javascript -->
    <script>
      //Handle multiple sliders input crdhange event
      var rangeSlider = function() {
        var sliders = document.querySelectorAll('.range-slider');
        
        sliders.forEach(function(slider) {
            var range = slider.querySelector('.range-slider__range');
            var value = slider.querySelector('.range-slider__value');

            var values = slider.querySelectorAll('.range-slider__value');
            values.forEach(function(val) {
            var valValue = val.previousElementSibling.getAttribute('value');
            val.innerHTML = valValue;
            });

            range.addEventListener('input', function() {
            value.innerHTML = this.value;
            });
        });
      };

      rangeSlider();  
    </script>

    <!-- <script src="annotationScript.js"></script> -->
  </body>
</html>